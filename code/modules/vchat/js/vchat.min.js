(function(){if(navigator.userAgent.indexOf("Trident")>=0){let oldLog=console.log;console.log=function(message){send_debug(message);oldLog.apply(console,arguments)};let oldError=console.error;console.error=function(message){send_debug(message);oldError.apply(console,arguments)};window.onerror=function(message,url,line,col,error){let stacktrace="";if(error&&error.stack){stacktrace=error.stack}send_debug(message+" ("+url+"@"+line+":"+col+") "+error+"|UA: "+navigator.userAgent+"|Stack: "+stacktrace);return true}}})();var SKIN_BUTTONS=["rpane.textb","rpane.infob","rpane.wikib","rpane.forumb","rpane.rulesb","rpane.github","rpane.discord","rpane.mapb","rpane.changelog","mainwindow.saybutton","mainwindow.mebutton","mainwindow.hotkey_toggle"];var SKIN_ELEMENTS=["mainwindow","mainwindow.mainvsplit","mainwindow.tooltip","rpane","rpane.rpanewindow","rpane.mediapanel"];function switch_ui_mode(options){doWinset(SKIN_BUTTONS.reduce(function(params,ctl){params[ctl+".background-color"]=options.buttonBgColor;return params},{}));doWinset(SKIN_BUTTONS.reduce(function(params,ctl){params[ctl+".text-color"]=options.buttonTextColor;return params},{}));doWinset(SKIN_ELEMENTS.reduce(function(params,ctl){params[ctl+".background-color"]=options.windowBgColor;return params},{}));doWinset("infowindow",{"background-color":options.tabBackgroundColor,"text-color":options.tabTextColor});doWinset("infowindow.info",{"background-color":options.tabBackgroundColor,"text-color":options.tabTextColor,"highlight-color":options.highlightColor,"tab-text-color":options.tabTextColor,"tab-background-color":options.tabBackgroundColor})}function doWinset(control_id,params){if(typeof params==="undefined"){params=control_id;control_id=null}let url="byond://winset?";if(control_id){url+="id="+control_id+"&"}url+=Object.keys(params).map(function(ctl){return ctl+"="+encodeURIComponent(params[ctl])}).join("&");window.location=url}var vchat_opts={msBeforeDropped:3e4,cookiePrefix:"vst-",alwaysShow:["vc_looc","vc_system"],vchatTabsVer:1};var DARKMODE_COLORS={buttonBgColor:"#40628a",buttonTextColor:"#FFFFFF",windowBgColor:"#272727",highlightColor:"#009900",tabTextColor:"#FFFFFF",tabBackgroundColor:"#272727"};var LIGHTMODE_COLORS={buttonBgColor:"none",buttonTextColor:"#000000",windowBgColor:"none",highlightColor:"#007700",tabTextColor:"#000000",tabBackgroundColor:"none"};var domparser=new DOMParser;var storage_system=undefined;if(storageAvailable("serverStorage")){storage_system=window.serverStorage}else if(storageAvailable("localStorage")){storage_system=window.localStorage}else{send_debug("No storage system available, using cookies. Sad!")}var vchat_state={ready:false,byond_ip:null,byond_cid:null,byond_ckey:null,lastPingReceived:0,latency_sent:0,lastId:0};function start_vchat(){start_vue();vchat_state.ready=true;push_Topic("done_loading");push_Topic_showingnum(this.showingnum);doWinset("htmloutput",{"is-visible":true});doWinset("oldoutput",{"is-visible":false});doWinset("chatloadlabel",{"is-visible":false});doWinset("htmloutput",{size:"0x0"});doWinset("oldoutput",{size:"1x1"});doWinset("chatloadlabel",{size:"1x1"});doWinset("htmloutput",{pos:"0,0"});doWinset("oldoutput",{pos:"999,999"});doWinset("chatloadlabel",{pos:"999,999"});setInterval(check_ping,vchat_opts.msBeforeDropped);send_debug("VChat Loaded!")}var vueapp;function start_vue(){vueapp=new Vue({el:"#app",data:{messages:[],shown_messages:[],unshown_messages:0,archived_messages:[],tabs:[{name:"Main",categories:[],immutable:true,active:true}],unread_messages:{},editing:false,paused:false,latency:0,reconnecting:false,ext_styles:"",is_admin:false,inverted:false,crushing:3,animated:false,fontsize:.9,lineheight:130,showingnum:200,type_table:[{matches:".filter_say, .say, .emote, .emote_subtle",becomes:"vc_localchat",pretty:"Local Chat",tooltip:"In-character local messages (say, emote, etc)",required:false,admin:false},{matches:".filter_radio, .alert, .syndradio, .centradio, .airadio, .entradio, .comradio, .secradio, .engradio, .medradio, .sciradio, .supradio, .srvradio, .expradio, .radio, .deptradio, .newscaster",becomes:"vc_radio",pretty:"Radio Comms",tooltip:"All departments of radio messages",required:false,admin:false},{matches:".filter_notice, .notice:not(.pm), .adminnotice, .info, .sinister, .cult",becomes:"vc_info",pretty:"Notices",tooltip:"Non-urgent messages from the game and items",required:false,admin:false},{matches:".filter_warning, .warning:not(.pm), .critical, .userdanger, .italics",becomes:"vc_warnings",pretty:"Warnings",tooltip:"Urgent messages from the game and items",required:false,admin:false},{matches:".filter_deadsay, .deadsay",becomes:"vc_deadchat",pretty:"Deadchat",tooltip:"All of deadchat",required:false,admin:false},{matches:".filter_pray",becomes:"vc_pray",pretty:"Pray",tooltip:"Prayer messages",required:false,admin:false},{matches:".ooc, .filter_ooc",becomes:"vc_globalooc",pretty:"Global OOC",tooltip:"The bluewall of global OOC messages",required:false,admin:false},{matches:".nif",becomes:"vc_nif",pretty:"NIF Messages",tooltip:"Messages from the NIF itself and people inside",required:false,admin:false},{matches:".mentor_channel, .mentor",becomes:"vc_mentor",pretty:"Mentor messages",tooltip:"Mentorchat and mentor pms",required:false,admin:false},{matches:".filter_pm, .pm",becomes:"vc_adminpm",pretty:"Admin PMs",tooltip:"Messages to/from admins ('adminhelps')",required:false,admin:false},{matches:".filter_ASAY, .admin_channel",becomes:"vc_adminchat",pretty:"Admin Chat",tooltip:"ASAY messages",required:false,admin:true},{matches:".filter_MSAY, .mod_channel",becomes:"vc_modchat",pretty:"Mod Chat",tooltip:"MSAY messages",required:false,admin:true},{matches:".filter_ESAY, .event_channel",becomes:"vc_eventchat",pretty:"Event Chat",tooltip:"ESAY messages",required:false,admin:true},{matches:".filter_combat, .danger",becomes:"vc_combat",pretty:"Combat Logs",tooltip:"Urist McTraitor has stabbed you with a knife!",required:false,admin:false},{matches:".filter_adminlogs, .log_message",becomes:"vc_adminlogs",pretty:"Admin Logs",tooltip:"ADMIN LOG: Urist McAdmin has jumped to coordinates X, Y, Z",required:false,admin:true},{matches:".filter_attacklogs",becomes:"vc_attacklogs",pretty:"Attack Logs",tooltip:"Urist McTraitor has shot John Doe",required:false,admin:true},{matches:".filter_debuglogs",becomes:"vc_debuglogs",pretty:"Debug Logs",tooltip:"DEBUG: SSPlanets subsystem Recover().",required:false,admin:true},{matches:".looc",becomes:"vc_looc",pretty:"Local OOC",tooltip:"Local OOC messages, always enabled",required:true},{matches:".rlooc",becomes:"vc_rlooc",pretty:"Remote LOOC",tooltip:"Remote LOOC messages",required:false,admin:true},{matches:".boldannounce, .filter_system",becomes:"vc_system",pretty:"System Messages",tooltip:"Messages from your client, always enabled",required:true},{matches:".unsorted",becomes:"vc_unsorted",pretty:"Unsorted",tooltip:"Messages that don't have any filters.",required:false,admin:false}]},mounted:function(){this.load_settings();let xhr=new XMLHttpRequest;xhr.open("GET","ss13styles.css");xhr.onreadystatechange=function(){this.ext_styles=xhr.responseText}.bind(this);xhr.send()},updated:function(){if(!this.editing&&!this.paused){window.scrollTo(0,document.getElementById("messagebox").scrollHeight)}},watch:{reconnecting:function(newSetting,oldSetting){if(newSetting==true&&oldSetting==false){this.internal_message("Your client has lost connection to the server, or there is severe lag. Your client will reconnect if possible.")}else if(newSetting==false&&oldSetting==true){this.internal_message("Your client has reconnected to the server.")}},inverted:function(newSetting){set_storage("darkmode",newSetting);if(newSetting){document.body.classList.add("inverted");switch_ui_mode(DARKMODE_COLORS)}else{document.body.classList.remove("inverted");switch_ui_mode(LIGHTMODE_COLORS)}},crushing:function(newSetting){set_storage("crushing",newSetting)},animated:function(newSetting){set_storage("animated",newSetting)},fontsize:function(newSetting,oldSetting){if(isNaN(newSetting)){this.fontsize=oldSetting;return}if(newSetting<.2){this.fontsize=.2}else if(newSetting>5){this.fontsize=5}set_storage("fontsize",newSetting)},lineheight:function(newSetting,oldSetting){if(!isFinite(newSetting)){this.lineheight=oldSetting;return}if(newSetting<100){this.lineheight=100}else if(newSetting>200){this.lineheight=200}set_storage("lineheight",newSetting)},showingnum:function(newSetting,oldSetting){if(!isFinite(newSetting)){this.showingnum=oldSetting;return}newSetting=Math.floor(newSetting);if(newSetting<50){this.showingnum=50}else if(newSetting>2e3){this.showingnum=2e3}set_storage("showingnum",this.showingnum);push_Topic_showingnum(this.showingnum);this.attempt_archive()},current_categories:function(newSetting){if(newSetting.length){this.apply_filter(newSetting)}}},computed:{active_tab:function(){let tab=this.tabs.find(function(tab){return tab.active});return tab},ping_classes:function(){if(!this.latency){return this.reconnecting?"red":"green"}if(this.latency=="?"){return"grey"}else if(this.latency<0){return"red"}else if(this.latency<=200){return"green"}else if(this.latency<=400){return"yellow"}else{return"grey"}},current_categories:function(){if(this.active_tab==this.tabs[0]){return[]}else{return this.active_tab.categories.concat(vchat_opts.alwaysShow)}}},methods:{load_settings:function(){this.inverted=get_storage("darkmode",false);this.crushing=get_storage("crushing",3);this.animated=get_storage("animated",false);this.fontsize=get_storage("fontsize",.9);this.lineheight=get_storage("lineheight",130);this.showingnum=get_storage("showingnum",200);if(isNaN(this.crushing)){this.crushing=3}if(isNaN(this.fontsize)){this.fontsize=.9}this.load_tabs()},load_tabs:function(){let loadstring=get_storage("tabs");if(!loadstring)return;let loadfile=JSON.parse(loadstring);if(!loadfile.version||!loadfile.tabs){this.internal_message("There was a problem loading your tabs. Any new ones you make will be saved, however.");return}if(!loadfile.version==vchat_opts.vchatTabsVer){this.internal_message("Your saved tabs are for an older version of VChat and must be recreated, sorry.");return}this.tabs.push.apply(this.tabs,loadfile.tabs)},save_tabs:function(){let savefile={version:vchat_opts.vchatTabsVer,tabs:[]};this.tabs.forEach(function(tab){if(tab.immutable)return;let name=tab.name;let categories=[];tab.categories.forEach(function(category){categories.push(category)});let cleantab={name:name,categories:categories,immutable:false,active:false};savefile.tabs.push(cleantab)});let savestring=JSON.stringify(savefile);set_storage("tabs",savestring)},switchtab:function(tab){if(tab==this.active_tab)return;this.active_tab.active=false;tab.active=true;tab.categories.forEach(function(cls){this.unread_messages[cls]=0},this);this.apply_filter(this.current_categories)},editmode:function(){this.editing=!this.editing;this.save_tabs()},pause:function(){this.paused=!this.paused},newtab:function(){this.tabs.push({name:"New Tab",categories:[],immutable:false,active:false});this.switchtab(this.tabs[this.tabs.length-1])},renametab:function(){if(this.active_tab.immutable){return}let tabtorename=this.active_tab;let newname=window.prompt("Type the desired tab name:",tabtorename.name);if(newname===null||newname===""||tabtorename===null){return}tabtorename.name=newname},deltab:function(tab){if(!tab){tab=this.active_tab}if(tab.immutable){return}this.switchtab(this.tabs[0]);this.tabs.splice(this.tabs.indexOf(tab),1)},movetab:function(tab,shift){if(!tab||tab.immutable){return}let at=this.tabs.indexOf(tab);let to=at+shift;this.tabs.splice(to,0,this.tabs.splice(at,1)[0])},tab_unread_count:function(tab){let unreads=0;let thisum=this.unread_messages;tab.categories.find(function(cls){if(thisum[cls]){unreads+=thisum[cls]}});return unreads},tab_unread_categories:function(tab){let unreads=false;let thisum=this.unread_messages;tab.categories.find(function(cls){if(thisum[cls]){unreads=true;return true}});return{red:unreads,grey:!unreads}},attempt_archive:function(){let wiggle=20;if(this.messages.length>this.showingnum){let too_old=this.messages.splice(0,wiggle);Array.prototype.push.apply(this.archived_messages,too_old)}},apply_filter:function(cat_array){this.shown_messages.splice(0);this.unshown_messages=0;this.messages.forEach(function(msg){if(cat_array.indexOf(msg.category)>-1){this.shown_messages.push(msg)}},this);this.archived_messages.forEach(function(msg){if(cat_array.indexOf(msg.category)>-1){this.unshown_messages++}},this)},add_message:function(message){let newmessage={time:message.time,category:"error",content:message.message,repeats:1};newmessage.category=this.get_category(newmessage.content);if(newmessage.category=="vc_unsorted"){newmessage.content="<span class='unsorted'>"+newmessage.content+"</span>"}if(this.crushing){let crushwith=this.messages.slice(-this.crushing);for(let i=crushwith.length-1;i>=0;i--){let oldmessage=crushwith[i];if(oldmessage.content==newmessage.content){newmessage.repeats+=oldmessage.repeats;this.messages.splice(this.messages.indexOf(oldmessage),1)}}}newmessage.content=newmessage.content.replace(/(\b(https?):\/\/[-A-Z0-9+&@#/%?=~_|!:,.;]*[-A-Z0-9+&@#/%=~_|])/gim,'<a href="$1">$1</a>');if(this.current_categories.length&&this.current_categories.indexOf(newmessage.category)<0){if(isNaN(this.unread_messages[newmessage.category])){this.unread_messages[newmessage.category]=0}this.unread_messages[newmessage.category]+=1}else if(this.current_categories.length){this.shown_messages.push(newmessage)}newmessage.id=++vchat_state.lastId;this.attempt_archive();this.messages.push(newmessage)},internal_message:function(message){let newmessage={time:this.messages.length?this.messages.slice(-1).time+1:0,category:"vc_system",content:"<span class='notice'>[VChat Internal] "+message+"</span>"};newmessage.id=++vchat_state.lastId;this.messages.push(newmessage)},on_mouseup:function(event){let ele=event.target;let textSelected="getSelection"in window&&window.getSelection().isCollapsed===false;if(!textSelected&&!(ele&&(ele.tagName==="INPUT"||ele.tagName==="TEXTAREA"))){focusMapWindow();if(navigator.userAgent.indexOf("Trident")>=0){event.preventDefault();event.target.click()}}},click_message:function(event){let ele=event.target;if(ele.tagName==="A"){event.stopPropagation();event.preventDefault?event.preventDefault():event.returnValue=false;let href=ele.getAttribute("href");if(href[0]=="?"||href.length>=8&&href.substring(0,8)=="byond://"){window.location=href}else{window.location="byond://?action=openLink&link="+encodeURIComponent(href)}}},get_category:function(message){if(!vchat_state.ready){push_Topic("not_ready");return}let doc=domparser.parseFromString(message,"text/html");let evaluating=doc.querySelector("span");let category="vc_unsorted";if(!evaluating)return category;this.type_table.find(function(type){if(evaluating.matches(type.matches)){category=type.becomes;return true}});return category},save_chatlog:function(){let textToSave="<html><head><style>"+this.ext_styles+"</style></head><body>";let messagesToSave=this.archived_messages.concat(this.messages);let cats=this.current_categories;messagesToSave.forEach(function(message){if(cats.length==0||cats.indexOf(message.category)>=0){textToSave+=message.content;if(message.repeats>1){textToSave+="(x"+message.repeats+")"}textToSave+="<br>\n"}});textToSave+="</body></html>";let fileprefix="log";let extension=".html";let now=new Date;let hours=String(now.getHours());if(hours.length<2){hours="0"+hours}let minutes=String(now.getMinutes());if(minutes.length<2){minutes="0"+minutes}let dayofmonth=String(now.getDate());if(dayofmonth.length<2){dayofmonth="0"+dayofmonth}let month=String(now.getMonth()+1);if(month.length<2){month="0"+month}let year=String(now.getFullYear());let datesegment=" "+year+"-"+month+"-"+dayofmonth+" ("+hours+" "+minutes+")";let filename=fileprefix+datesegment+extension;let hiddenElement=document.createElement("a");if(hiddenElement.download!==undefined){hiddenElement.href="data:attachment/text,"+encodeURI(textToSave);hiddenElement.target="_blank";hiddenElement.download=filename;hiddenElement.click()}else{let blob=new Blob([textToSave],{type:"text/html;charset=utf8;"});window.navigator.msSaveOrOpenBlob(blob,filename)}},do_latency_test:function(){send_latency_check()},blur_this:function(event){event.target.blur()}}})}function check_ping(){let time_ago=Date.now()-vchat_state.lastPingReceived;if(time_ago>vchat_opts.msBeforeDropped)vueapp.reconnecting=true}function send_latency_check(){if(vchat_state.latency_sent)return;vchat_state.latency_sent=Date.now();vueapp.latency="?";push_Topic("ping");setTimeout(function(){if(vchat_state.latency_ms=="?"){vchat_state.latency_ms=999}},1e3);setTimeout(function(){vchat_state.latency_sent=0;vueapp.latency=0},5e3)}function get_latency_check(){if(!vchat_state.latency_sent){return}vueapp.latency=Date.now()-vchat_state.latency_sent}function byondDecode(message){message=message.replace(/\+/g,"%20");try{message=decodeURIComponent(message)}catch(err){message=unescape(message)}return JSON.parse(message)}function putmessage(messages){messages=byondDecode(messages);if(Array.isArray(messages)){messages.forEach(function(message){vueapp.add_message(message)})}else if(typeof messages==="object"){vueapp.add_message(messages)}}function system_message(message){vueapp.internal_message(message)}function push_Topic(topic_uri){window.location="?_src_=chat&proc="+topic_uri}function push_Topic_showingnum(topic_num){window.location="?_src_=chat&showingnum="+topic_num}function focusMapWindow(){window.location="byond://winset?mapwindow.map.focus=true"}function send_debug(message){push_Topic("debug&param[message]="+encodeURIComponent(message))}function get_event(event){if(!vchat_state.ready){push_Topic("not_ready");return}let parsed_event={evttype:"internal_error",event:event};parsed_event=byondDecode(event);switch(parsed_event.evttype){case"internal_error":system_message("Event parse error: "+event);break;case"byond_player":send_client_data();vueapp.is_admin=parsed_event.admin==="true";vchat_state.byond_ip=parsed_event.address;vchat_state.byond_cid=parsed_event.cid;vchat_state.byond_ckey=parsed_event.ckey;set_storage("ip",vchat_state.byond_ip);set_storage("cid",vchat_state.byond_cid);set_storage("ckey",vchat_state.byond_ckey);break;case"keepalive":vchat_state.lastPingReceived=Date.now();vueapp.reconnecting=false;break;case"pong":get_latency_check();break;case"availability":push_Topic("done_loading");break;default:system_message("Didn't know what to do with event: "+event)}}function send_client_data(){let client_data={ip:get_storage("ip"),cid:get_storage("cid"),ckey:get_storage("ckey")};push_Topic("ident&param[clientdata]="+JSON.stringify(client_data))}function set_storage(key,value){if(!storage_system)return;storage_system.setItem(vchat_opts.cookiePrefix+key,value)}function get_storage(key,default_value){if(!storage_system)return default_value;let value=storage_system.getItem(vchat_opts.cookiePrefix+key);if(value==="null"||value===null){value=default_value}else if(value==="true"){value=true}else if(value==="false"){value=false}else if(!isNaN(value)){value=+value}return value}function set_cookie(key,value){let now=new Date;now.setFullYear(now.getFullYear()+1);let then=now.toUTCString();document.cookie=vchat_opts.cookiePrefix+key+"="+value+";expires="+then+";path=/"}function get_cookie(key,deffo){let candidates={cookie:null,localstorage:null,indexeddb:null};let cookie_array=document.cookie.split(";");let cookie_object={};cookie_array.forEach(function(element){let clean=element.replace(vchat_opts.cookiePrefix,"").trim();let equals=clean.search("=");let left=decodeURIComponent(clean.substring(0,equals));let right=decodeURIComponent(clean.substring(equals+1));if(right=="null"||right===null){right=deffo}else if(right==="true"){right=true}else if(right==="false"){right=false}else if(!isNaN(right)){right=+right}cookie_object[left]=right});candidates.cookie=cookie_object[key]}