!function(){if(navigator.userAgent.indexOf("Trident")>=0){let e=console.log;console.log=function(t){send_debug(t),e.apply(console,arguments)};let t=console.error;console.error=function(e){send_debug(e),t.apply(console,arguments)},window.onerror=function(e,t,s,i,r){let o="";return r&&r.stack&&(o=r.stack),send_debug(e+" ("+t+"@"+s+":"+i+") "+r+"|UA: "+navigator.userAgent+"|Stack: "+o),!0}}}();var vueapp,SKIN_BUTTONS=["rpane.textb","rpane.infob","rpane.wikib","rpane.forumb","rpane.rulesb","rpane.github","rpane.discord","rpane.mapb","rpane.changelog","mainwindow.saybutton","mainwindow.mebutton","mainwindow.hotkey_toggle"],SKIN_ELEMENTS=["mainwindow","mainwindow.mainvsplit","mainwindow.tooltip","rpane","rpane.rpanewindow","rpane.mediapanel",];function switch_ui_mode(e){doWinset(SKIN_BUTTONS.reduce(function(t,s){return t[s+".background-color"]=e.buttonBgColor,t},{})),doWinset(SKIN_BUTTONS.reduce(function(t,s){return t[s+".text-color"]=e.buttonTextColor,t},{})),doWinset(SKIN_ELEMENTS.reduce(function(t,s){return t[s+".background-color"]=e.windowBgColor,t},{})),doWinset("infowindow",{"background-color":e.tabBackgroundColor,"text-color":e.tabTextColor}),doWinset("infowindow.info",{"background-color":e.tabBackgroundColor,"text-color":e.tabTextColor,"highlight-color":e.highlightColor,"tab-text-color":e.tabTextColor,"tab-background-color":e.tabBackgroundColor})}function doWinset(e,t){void 0===t&&(t=e,e=null);let s="byond://winset?";e&&(s+="id="+e+"&"),s+=Object.keys(t).map(function(e){return e+"="+encodeURIComponent(t[e])}).join("&"),window.location=s}var vchat_opts={msBeforeDropped:3e4,cookiePrefix:"vst-",alwaysShow:["vc_looc","vc_system"],vchatTabsVer:1},DARKMODE_COLORS={buttonBgColor:"#40628a",buttonTextColor:"#FFFFFF",windowBgColor:"#272727",highlightColor:"#009900",tabTextColor:"#FFFFFF",tabBackgroundColor:"#272727"},LIGHTMODE_COLORS={buttonBgColor:"none",buttonTextColor:"#000000",windowBgColor:"none",highlightColor:"#007700",tabTextColor:"#000000",tabBackgroundColor:"none"},domparser=new DOMParser,storage_system=void 0;storageAvailable("serverStorage")?storage_system=window.serverStorage:storageAvailable("localStorage")?storage_system=window.localStorage:send_debug("No storage system available, using cookies. Sad!");var vchat_state={ready:!1,byond_ip:null,byond_cid:null,byond_ckey:null,lastPingReceived:0,latency_sent:0,lastId:0};function start_vchat(){start_vue(),vchat_state.ready=!0,push_Topic("done_loading"),push_Topic_showingnum(this.showingnum),void 0!==vueapp&&vueapp&&"function"==typeof vueapp.request_round_overview&&vueapp.request_round_overview(),doWinset("htmloutput",{"is-visible":!0}),doWinset("oldoutput",{"is-visible":!1}),doWinset("chatloadlabel",{"is-visible":!1}),doWinset("htmloutput",{size:"0x0"}),doWinset("oldoutput",{size:"1x1"}),doWinset("chatloadlabel",{size:"1x1"}),doWinset("htmloutput",{pos:"0,0"}),doWinset("oldoutput",{pos:"999,999"}),doWinset("chatloadlabel",{pos:"999,999"}),setInterval(check_ping,vchat_opts.msBeforeDropped),send_debug("VChat Loaded!")}function start_vue(){vueapp=new Vue({el:"#app",data:{messages:[],shown_messages:[],unshown_messages:0,archived_messages:[],tabs:[{name:"Main",categories:[],immutable:!0,active:!0}],unread_messages:{},editing:!1,paused:!1,manual_paused:!1,scroll_paused:!1,latency:0,reconnecting:!1,ext_styles:"",is_admin:!1,inverted:!1,crushing:3,animated:!1,fontsize:.9,lineheight:130,fontfamily_default:"Verdana, Arial, sans-serif",fontfamily:"Verdana, Arial, sans-serif",showingnum:50,pending_chatlog:null,round_selector:{visible:!1,loading:!1,options:[],error:"",totalMessages:0,roundTotal:0,currentOption:null},round_overview:{loading:!1,loaded:!1,error:"",totalMessages:0,currentRoundId:"",options:[]},history_viewer:{visible:!1,loading:!1,error:"",messages:[],roundId:"",roundLabel:"",requestedRound:"",roundsLoading:!1,messageCount:0,resolvedRoundId:""},archived_dom:null,pending_archived:[],active_round_id:"",last_loaded_round_id:"",pending_main_round_id:"",fontfamily_options:[{label:"Verdana (Default)",value:"Verdana, Arial, sans-serif"},{label:"Bahnschrift",value:'Bahnschrift, "Segoe UI", Arial, sans-serif'},{label:"Calibri",value:'Calibri, "Segoe UI", Arial, sans-serif'},{label:"Century Gothic",value:'"Century Gothic", "Segoe UI", Arial, sans-serif'},{label:"Comic Sans MS",value:'"Comic Sans MS", "Comic Sans", cursive'},{label:"Consolas",value:'Consolas, "Courier New", Courier, monospace'},{label:"Gabriola",value:'Gabriola, "Segoe Script", "Segoe UI", cursive'},{label:"Ink Free",value:'"Ink Free", "Comic Sans MS", cursive'},{label:"Wingdings",value:'Wingdings, "Segoe UI Symbol", sans-serif'},{label:"Georgia",value:'Georgia, "Times New Roman", serif'},{label:"Impact",value:'Impact, Haettenschweiler, "Arial Narrow Bold", sans-serif'},{label:"Palatino Linotype",value:'"Palatino Linotype", "Book Antiqua", Palatino, serif'},{label:"Segoe Script",value:'"Segoe Script", "Comic Sans MS", cursive'},{label:"Segoe UI",value:'"Segoe UI", Tahoma, Geneva, Verdana, sans-serif'}],type_table:[{matches:".filter_say, .say, .emote, .emote_subtle",becomes:"vc_localchat",pretty:"Local Chat",tooltip:"In-character local messages (say, emote, etc)",required:!1,admin:!1},{matches:".filter_radio, .alert, .syndradio, .centradio, .airadio, .entradio, .comradio, .secradio, .engradio, .medradio, .sciradio, .supradio, .srvradio, .expradio, .radio, .deptradio, .newscaster",becomes:"vc_radio",pretty:"Radio Comms",tooltip:"All departments of radio messages",required:!1,admin:!1},{matches:".filter_notice, .notice:not(.pm), .adminnotice, .info, .sinister, .cult",becomes:"vc_info",pretty:"Notices",tooltip:"Non-urgent messages from the game and items",required:!1,admin:!1},{matches:".filter_warning, .warning:not(.pm), .critical, .userdanger, .italics",becomes:"vc_warnings",pretty:"Warnings",tooltip:"Urgent messages from the game and items",required:!1,admin:!1},{matches:".filter_deadsay, .deadsay",becomes:"vc_deadchat",pretty:"Deadchat",tooltip:"All of deadchat",required:!1,admin:!1},{matches:".filter_pray",becomes:"vc_pray",pretty:"Pray",tooltip:"Prayer messages",required:!1,admin:!1},{matches:".ooc, .filter_ooc",becomes:"vc_globalooc",pretty:"Global OOC",tooltip:"The bluewall of global OOC messages",required:!1,admin:!1},{matches:".nif",becomes:"vc_nif",pretty:"NIF Messages",tooltip:"Messages from the NIF itself and people inside",required:!1,admin:!1},{matches:".mentor_channel, .mentor",becomes:"vc_mentor",pretty:"Mentor messages",tooltip:"Mentorchat and mentor pms",required:!1,admin:!1},{matches:".filter_pm, .pm",becomes:"vc_adminpm",pretty:"Admin PMs",tooltip:"Messages to/from admins ('adminhelps')",required:!1,admin:!1},{matches:".filter_ASAY, .admin_channel",becomes:"vc_adminchat",pretty:"Admin Chat",tooltip:"ASAY messages",required:!1,admin:!0},{matches:".filter_MSAY, .mod_channel",becomes:"vc_modchat",pretty:"Mod Chat",tooltip:"MSAY messages",required:!1,admin:!0},{matches:".filter_ESAY, .event_channel",becomes:"vc_eventchat",pretty:"Event Chat",tooltip:"ESAY messages",required:!1,admin:!0},{matches:".filter_combat, .danger",becomes:"vc_combat",pretty:"Combat Logs",tooltip:"Urist McTraitor has stabbed you with a knife!",required:!1,admin:!1},{matches:".filter_adminlogs, .log_message",becomes:"vc_adminlogs",pretty:"Admin Logs",tooltip:"ADMIN LOG: Urist McAdmin has jumped to coordinates X, Y, Z",required:!1,admin:!0},{matches:".filter_attacklogs",becomes:"vc_attacklogs",pretty:"Attack Logs",tooltip:"Urist McTraitor has shot John Doe",required:!1,admin:!0},{matches:".filter_debuglogs",becomes:"vc_debuglogs",pretty:"Debug Logs",tooltip:"DEBUG: SSPlanets subsystem Recover().",required:!1,admin:!0},{matches:".looc",becomes:"vc_looc",pretty:"Local OOC",tooltip:"Local OOC messages, always enabled",required:!0},{matches:".rlooc",becomes:"vc_rlooc",pretty:"Remote LOOC",tooltip:"Remote LOOC messages",required:!1,admin:!0},{matches:".boldannounce, .filter_system",becomes:"vc_system",pretty:"System Messages",tooltip:"Messages from your client, always enabled",required:!0},{matches:".unsorted",becomes:"vc_unsorted",pretty:"Unsorted",tooltip:"Messages that don't have any filters.",required:!1,admin:!1}]},mounted:function(){this.load_settings();let e=new XMLHttpRequest;e.open("GET","ss13styles.css"),e.onreadystatechange=(function(){this.ext_styles=e.responseText}).bind(this),e.send(),this.$nextTick((function(){this.archived_dom=this.$refs.archivedMessages||null,this.flush_pending_archived(),this.update_archived_filter(this.current_categories)}).bind(this)),this._suppress_scroll_update=!0,this._boundScrollHandler=this.handle_window_scroll.bind(this);try{window.addEventListener("scroll",this._boundScrollHandler,{passive:!0})}catch(t){window.addEventListener("scroll",this._boundScrollHandler)}this.$nextTick((function(){this.scroll_to_latest();let e=(function(){this._suppress_scroll_update=!1,this.resume_autoscroll(),this.handle_window_scroll()}).bind(this);"function"==typeof window.requestAnimationFrame?window.requestAnimationFrame(e):setTimeout(e,0)}).bind(this))},beforeDestroy:function(){this._boundScrollHandler&&(window.removeEventListener("scroll",this._boundScrollHandler),this._boundScrollHandler=null)},updated:function(){this.editing||this.paused||this.scroll_to_latest()},watch:{reconnecting:function(e,t){!0==e&&!1==t?this.internal_message("Your client has lost connection to the server, or there is severe lag. Your client will reconnect if possible."):!1==e&&!0==t&&this.internal_message("Your client has reconnected to the server.")},inverted:function(e){set_storage("darkmode",e),e?(document.body.classList.add("inverted"),switch_ui_mode(DARKMODE_COLORS)):(document.body.classList.remove("inverted"),switch_ui_mode(LIGHTMODE_COLORS))},crushing:function(e){set_storage("crushing",e)},animated:function(e){set_storage("animated",e)},fontsize:function(e,t){if(isNaN(e)){this.fontsize=t;return}e<.2?this.fontsize=.2:e>5&&(this.fontsize=5),set_storage("fontsize",e)},lineheight:function(e,t){if(!isFinite(e)){this.lineheight=t;return}e<100?this.lineheight=100:e>200&&(this.lineheight=200),set_storage("lineheight",e)},fontfamily:function(e,t){if("string"!=typeof e){let s="string"==typeof t&&t.trim().length?t.trim():this.fontfamily_default;this.fontfamily=s,set_storage("fontfamily",s);return}let i=e.trim();if(!i.length){this.fontfamily=this.fontfamily_default,set_storage("fontfamily",this.fontfamily);return}this.fontfamily!==i&&(this.fontfamily=i);if(!this.fontfamily_options.some(function(e){return e&&e.value===i})){let r=i.split(",")[0]||"";(r=r.replace(/['"]/g,"").trim()).length||(r="Custom"),this.fontfamily_options.push({label:r,value:i})}set_storage("fontfamily",i)},showingnum:function(){this.showingnum=50,set_storage("showingnum",this.showingnum),push_Topic_showingnum(this.showingnum)},current_categories:function(e){this.update_archived_filter(e),e.length&&this.apply_filter(e)}},computed:{active_tab:function(){return this.tabs.find(function(e){return e.active})},ping_classes:function(){return this.latency?"?"==this.latency?"grey":this.latency<0?"red":this.latency<=200?"green":this.latency<=400?"yellow":"grey":this.reconnecting?"red":"green"},current_categories:function(){return this.active_tab==this.tabs[0]?[]:this.active_tab.categories.concat(vchat_opts.alwaysShow)},filtered_history_messages:function(){let e=Array.isArray(this.history_viewer.messages)?this.history_viewer.messages:[],t=this.current_categories;return Array.isArray(t)&&t.length?e.filter(function(e){if(!e||"object"!=typeof e)return!1;let s="string"==typeof e.category&&e.category.length?e.category:"vc_unsorted";return t.indexOf(s)>-1}):e}},methods:{load_settings:function(){this.inverted=get_storage("darkmode",!1),this.crushing=get_storage("crushing",3),this.animated=get_storage("animated",!1),this.fontsize=get_storage("fontsize",.9),this.lineheight=get_storage("lineheight",130),this.fontfamily=get_storage("fontfamily",this.fontfamily_default),this.showingnum=50,set_storage("showingnum",this.showingnum),isNaN(this.crushing)&&(this.crushing=3),isNaN(this.fontsize)&&(this.fontsize=.9),"string"==typeof this.fontfamily&&this.fontfamily.trim().length?this.fontfamily=this.fontfamily.trim():this.fontfamily=this.fontfamily_default;if(!this.fontfamily_options.some(function(e){return e&&e.value===this.fontfamily},this)){let e=this.fontfamily.split(",")[0]||"";(e=e.replace(/['"]/g,"").trim()).length||(e="Custom"),this.fontfamily_options.push({label:e,value:this.fontfamily})}this.load_tabs()},load_tabs:function(){let e=get_storage("tabs");if(!e)return;let t=JSON.parse(e);if(!t.version||!t.tabs){this.internal_message("There was a problem loading your tabs. Any new ones you make will be saved, however.");return}if(!t.version==vchat_opts.vchatTabsVer){this.internal_message("Your saved tabs are for an older version of VChat and must be recreated, sorry.");return}this.tabs.push.apply(this.tabs,t.tabs)},save_tabs:function(){let e={version:vchat_opts.vchatTabsVer,tabs:[]};this.tabs.forEach(function(t){if(t.immutable)return;let s=t.name,i=[];t.categories.forEach(function(e){i.push(e)}),e.tabs.push({name:s,categories:i,immutable:!1,active:!1})});set_storage("tabs",JSON.stringify(e))},switchtab:function(e){e!=this.active_tab&&(this.active_tab.active=!1,e.active=!0,e.categories.forEach(function(e){this.unread_messages[e]=0},this),this.apply_filter(this.current_categories),this.update_archived_filter(this.current_categories))},editmode:function(){this.editing=!this.editing,this.save_tabs()},pause:function(){if(this.manual_paused){this.manual_paused=!1,this.scroll_paused&&(this.scroll_paused=!1),this.update_pause_state(),this.paused||this.scroll_to_latest();return}if(this.scroll_paused){this.scroll_paused=!1,this.update_pause_state(),this.paused||this.scroll_to_latest();return}this.manual_paused=!0,this.update_pause_state()},update_pause_state:function(){let e=this.manual_paused||this.scroll_paused;this.paused!==e&&(this.paused=e)},resume_autoscroll:function(){let e=this.manual_paused||this.scroll_paused||this.paused;this.manual_paused=!1,this.scroll_paused=!1,this.update_pause_state(),(e||!this.is_near_bottom())&&this.scroll_to_latest()},scroll_to_latest:function(){let e=document.getElementById("messagebox"),t=document.documentElement,s=document.body,i=0;t&&"number"==typeof t.scrollHeight&&(i=Math.max(i,t.scrollHeight)),s&&"number"==typeof s.scrollHeight&&(i=Math.max(i,s.scrollHeight)),window.scrollTo(0,e?e.scrollHeight:i)},handle_window_scroll:function(){if(!this._suppress_scroll_update&&!this.editing)this.is_near_bottom()?this.scroll_paused&&(this.scroll_paused=!1,this.update_pause_state()):this.scroll_paused||(this.scroll_paused=!0,this.update_pause_state())},is_near_bottom:function(){let e=document.documentElement,t=document.body,s=document.getElementById("messagebox"),i;i=void 0!==window.pageYOffset?window.pageYOffset:e&&"number"==typeof e.scrollTop?e.scrollTop:t&&"number"==typeof t.scrollTop?t.scrollTop:0;let r=window.innerHeight||(e&&"number"==typeof e.clientHeight?e.clientHeight:0);!r&&t&&"number"==typeof t.clientHeight&&(r=t.clientHeight);let o=0;return e&&"number"==typeof e.scrollHeight&&(o=Math.max(o,e.scrollHeight)),t&&"number"==typeof t.scrollHeight&&(o=Math.max(o,t.scrollHeight)),s&&"number"==typeof s.scrollHeight&&(o=Math.max(o,s.scrollHeight)),o-(i+r)<=12},newtab:function(){this.tabs.push({name:"New Tab",categories:[],immutable:!1,active:!1}),this.switchtab(this.tabs[this.tabs.length-1])},renametab:function(){if(this.active_tab.immutable)return;let e=this.active_tab,t=window.prompt("Type the desired tab name:",e.name);null!==t&&""!==t&&null!==e&&(e.name=t)},deltab:function(e){e||(e=this.active_tab),!e.immutable&&(this.switchtab(this.tabs[0]),this.tabs.splice(this.tabs.indexOf(e),1))},movetab:function(e,t){if(!e||e.immutable)return;let s=this.tabs.indexOf(e);this.tabs.splice(s+t,0,this.tabs.splice(s,1)[0])},tab_unread_count:function(e){let t=0,s=this.unread_messages;return e.categories.find(function(e){s[e]&&(t+=s[e])}),t},tab_unread_categories:function(e){let t=!1,s=this.unread_messages;return e.categories.find(function(e){if(s[e])return t=!0,!0}),{red:t,grey:!t}},reset_chat_log:function(){if(this.messages.splice(0),this.shown_messages.splice(0),this.archived_messages.splice(0),this.unshown_messages=0,this.pending_archived=[],vchat_state.lastId=0,this.ensure_archived_dom(),this.archived_dom)for(;this.archived_dom.firstChild;)this.archived_dom.removeChild(this.archived_dom.firstChild)},attempt_archive:function(){if(this.messages.length>this.showingnum){let e=this.messages.splice(0,20);Array.prototype.push.apply(this.archived_messages,e),this.append_archived_messages(e)}},append_archived_messages:function(e,t){if(Array.isArray(e)&&e.length){if(this.ensure_archived_dom(),!this.archived_dom){for(let s=0;s<e.length;s++)this.pending_archived.push(e[s]);return}for(let i=0;i<e.length;i++){let r=e[i];if(!r||"object"!=typeof r)continue;let o=document.createElement("div");o.className="archived-message",o.dataset?o.dataset.category=r.category||"":o.setAttribute("data-category",r.category||"");let n=document.createElement("span");if(n.innerHTML="string"==typeof r.content?r.content:"",o.appendChild(n),r.repeats&&r.repeats>1){let a=document.createElement("span");a.className="ui grey circular label",a.textContent="x"+r.repeats,o.appendChild(a)}this.archived_dom.appendChild(o)}t||this.update_archived_filter(this.current_categories)}},flush_pending_archived:function(){if(!this.pending_archived.length)return;let e=this.pending_archived.slice();this.pending_archived=[],this.append_archived_messages(e,!0),this.update_archived_filter(this.current_categories)},ensure_archived_dom:function(){this.archived_dom||(this.archived_dom=this.$refs.archivedMessages||null)},update_archived_filter:function(e){if(this.ensure_archived_dom(),!this.archived_dom)return;let t=Array.isArray(e)?e:this.current_categories,s=!(t&&t.length),i=this.archived_dom.children;if(i)for(let r=0;r<i.length;r++){let o=i[r];if(!o)continue;let n="";o.dataset&&"string"==typeof o.dataset.category?n=o.dataset.category:"function"==typeof o.getAttribute&&(n=o.getAttribute("data-category")||"");let a=s||t&&-1!==t.indexOf(n);o.style.display=a?"":"none"}},on_round_overview_updated:function(e){let t="string"==typeof e?e:"";if(!t&&this.round_overview&&Array.isArray(this.round_overview.options)){let s=this.round_overview.options.find(function(e){return e&&e.isCurrent});s&&s.id&&(t=s.id)}this.active_round_id!==t?(this.active_round_id=t,this.load_current_round_history()):this.messages.length||this.archived_messages.length||this.load_current_round_history()},load_current_round_history:function(){let e=this.active_round_id||"";this.reset_chat_log(),this.request_main_history(e)},request_main_history:function(e){let t="string"==typeof e?e:"";this.pending_main_round_id=t||this.round_overview&&this.round_overview.currentRoundId||"";try{push_Topic("request_history&param[data]="+encodeURIComponent(JSON.stringify({round_id:t,source:"main"})))}catch(s){console.error(s),this.pending_main_round_id=""}},load_main_history:function(e){let t=Array.isArray(e.messages)?e.messages:[],s=this.resolve_event_round(e);this.last_loaded_round_id=s||"",this.reset_chat_log();let i=Math.max(t.length-this.showingnum,0),r=[];for(let o=0;o<t.length;o++){let n=t[o];if(!n||"object"!=typeof n)continue;let a="string"==typeof n.content?n.content:"",l={time:n.worldtime||0,category:this.get_category(a),content:a,repeats:1};l.id=++vchat_state.lastId,o<i?(this.archived_messages.push(l),r.push(l)):this.messages.push(l)}r.length&&this.append_archived_messages(r,!0),this.apply_filter(this.current_categories),this.resume_autoscroll(),this.pending_main_round_id=""},resolve_event_round:function(e){return!0===e.use_all_rounds||"true"===e.use_all_rounds||1===e.use_all_rounds?"all":"string"==typeof e.round_id&&e.round_id.length?e.round_id:"string"==typeof e.current_round_id&&e.current_round_id.length?e.current_round_id:""},apply_filter:function(e){this.shown_messages.splice(0),this.unshown_messages=0,this.update_archived_filter(e),this.messages.forEach(function(t){e.indexOf(t.category)>-1&&this.shown_messages.push(t)},this)},add_message:function(e){let t={time:e.time,category:"error",content:e.message,repeats:1};if(t.category=this.get_category(t.content),"vc_unsorted"==t.category&&(t.content="<span class='unsorted'>"+t.content+"</span>"),this.crushing){let s=this.messages.slice(-this.crushing);for(let i=s.length-1;i>=0;i--){let r=s[i];r.content==t.content&&(t.repeats+=r.repeats,this.messages.splice(this.messages.indexOf(r),1))}}t.content=t.content.replace(/(\b(https?):\/\/[-A-Z0-9+&@#/%?=~_|!:,.;]*[-A-Z0-9+&@#/%=~_|])/img,'<a href="$1">$1</a>'),this.current_categories.length&&0>this.current_categories.indexOf(t.category)?(isNaN(this.unread_messages[t.category])&&(this.unread_messages[t.category]=0),this.unread_messages[t.category]+=1):this.current_categories.length&&this.shown_messages.push(t),t.id=++vchat_state.lastId,this.attempt_archive(),this.messages.push(t)},internal_message:function(e){let t={time:this.messages.length?this.messages.slice(-1).time+1:0,category:"vc_system",content:"<span class='notice'>[VChat Internal] "+e+"</span>"};t.id=++vchat_state.lastId,this.messages.push(t)},on_mouseup:function(e){let t=e.target,s="getSelection"in window&&!1===window.getSelection().isCollapsed,i=!1,r=t;for(;r;){let o=r.tagName;if("INPUT"===o||"TEXTAREA"===o||"SELECT"===o||"OPTION"===o){i=!0;break}r=r.parentElement}s||i||(focusMapWindow(),navigator.userAgent.indexOf("Trident")>=0&&(e.preventDefault(),e.target.click()))},click_message:function(e){let t=e.target;if("A"===t.tagName){e.stopPropagation(),e.preventDefault?e.preventDefault():e.returnValue=!1;let s=t.getAttribute("href");"?"==s[0]||s.length>=8&&"byond://"==s.substring(0,8)?window.location=s:window.location="byond://?action=openLink&link="+encodeURIComponent(s)}},get_category:function(e){if(!vchat_state.ready){push_Topic("not_ready");return}let t=domparser.parseFromString(e,"text/html").querySelector("span"),s="vc_unsorted";return t&&this.type_table.find(function(e){if(t.matches(e.matches))return s=e.becomes,!0}),s},save_chatlog:function(){let e=Array.isArray(this.current_categories)?this.current_categories.slice():[],t=new Date,s=String(t.getHours());s.length<2&&(s="0"+s);let i=String(t.getMinutes());i.length<2&&(i="0"+i);let r=String(t.getDate());r.length<2&&(r="0"+r);let o=String(t.getMonth()+1);o.length<2&&(o="0"+o);let n=" "+String(t.getFullYear())+"-"+o+"-"+r+" ("+s+" "+i+")";this.prepare_chatlog_export(e,"log"+n+".html")},prepare_chatlog_export:function(e,t){this.pending_chatlog={categories:Array.isArray(e)?e.slice():[],filename:t},this.round_selector.visible=!0,this.round_selector.loading=!0,this.round_selector.error="",this.round_selector.options=[],this.round_selector.totalMessages=0,this.round_selector.roundTotal=0,this.round_selector.currentOption=null,this.request_round_overview()},receive_round_list:function(e){if(this.round_overview.loading=!1,!e||"object"!=typeof e){this.round_overview.error="Unable to load saved rounds.",this.round_selector.visible&&(this.round_selector.loading=!1,this.round_selector.error=this.round_overview.error),this.history_viewer.visible&&(this.history_viewer.roundsLoading=!1);return}let t=0;if("number"==typeof e.total_messages)t=e.total_messages;else if("string"==typeof e.total_messages){let s=parseInt(e.total_messages,10);t=isNaN(s)?0:s}let i=[];Array.isArray(e.rounds)&&(i=e.rounds.map(function(t){if(!t||"object"!=typeof t)return null;let s="string"==typeof t.id?t.id:"",i=t.message_count;"string"==typeof i&&(i=parseInt(i,10)),isFinite(i)||(i=0),i=Math.max(i,0);let r="string"==typeof t.start_display&&t.start_display.length?t.start_display:null,o="string"==typeof t.end_display&&t.end_display.length?t.end_display:null,n=!0===t.is_current||"true"===t.is_current||1===t.is_current;return n||"string"!=typeof e.current_round_id||s!==e.current_round_id||(n=!0),{id:s,messageCount:i,startDisplay:r,endDisplay:o,isCurrent:n,isOpen:!0===t.is_open||"true"===t.is_open||1===t.is_open}}).filter(function(e){return e&&e.id})),this.round_overview.options=i,this.round_overview.totalMessages=t,this.round_overview.currentRoundId="string"==typeof e.current_round_id?e.current_round_id:"",this.round_overview.error="string"==typeof e.error?e.error:"",this.round_overview.loaded=!0,this.on_round_overview_updated(this.round_overview.currentRoundId),this.round_selector.visible&&(this.round_selector.loading=!1,this.round_selector.error="",this.round_selector.options=i,this.round_selector.currentOption=i.find(function(e){return e&&e.isCurrent})||null,this.round_selector.roundTotal=i.length,this.round_selector.totalMessages=t,this.round_overview.error?this.round_selector.error=this.round_overview.error:i.length||(this.round_selector.error="No saved rounds were found. You can still export the current round or enter an ID manually.")),this.history_viewer.visible&&(this.history_viewer.roundsLoading=!1,this.history_viewer.roundLabel=this.resolve_history_round_label(this.history_viewer.roundId,this.history_viewer.resolvedRoundId))},request_round_overview:function(){this.round_overview.loading=!0,this.round_overview.error="",push_Topic("request_rounds")},open_history_viewer:function(){this.history_viewer.visible||(this.history_viewer.visible=!0,this.history_viewer.loading=!0,this.history_viewer.error="",this.history_viewer.messages=[],this.history_viewer.roundLabel="",this.history_viewer.roundId="",this.history_viewer.requestedRound="",this.history_viewer.messageCount=0,this.history_viewer.roundsLoading=!0,this.history_viewer.resolvedRoundId="",this.request_round_overview(),this.request_round_history("","viewer"))},close_history_viewer:function(){this.history_viewer.visible=!1,this.history_viewer.loading=!1,this.history_viewer.error="",this.history_viewer.messages=[],this.history_viewer.roundId="",this.history_viewer.roundLabel="",this.history_viewer.requestedRound="",this.history_viewer.messageCount=0,this.history_viewer.roundsLoading=!1,this.history_viewer.resolvedRoundId=""},change_history_round:function(e){let t="";e&&e.target&&(t=e.target.value),this.history_viewer.roundId=t,this.request_round_history(t,"viewer")},request_round_history:function(e,t){let s="string"==typeof t?t:"viewer",i="string"==typeof e?e:"";"viewer"===s&&(this.history_viewer.loading=!0,this.history_viewer.error="",this.history_viewer.messages=[],this.history_viewer.messageCount=0,this.history_viewer.requestedRound=i);try{push_Topic("request_history&param[data]="+encodeURIComponent(JSON.stringify({round_id:i,source:s})))}catch(r){console.error(r),"viewer"===s&&(this.history_viewer.loading=!1,this.history_viewer.error="Unable to request round history.")}},receive_round_history:function(e){if(!e||"object"!=typeof e){this.history_viewer.visible&&(this.history_viewer.loading=!1,this.history_viewer.error="Unable to load round history.");return}if("main"===("string"==typeof e.source?e.source:"viewer")){this.pending_main_round_id="";let t=this.resolve_event_round(e);if(this.active_round_id&&t&&t!==this.active_round_id)return;if(e.error&&"string"==typeof e.error&&e.error.length){this.reset_chat_log(),this.internal_message(e.error);return}this.load_main_history(e);return}if(!this.history_viewer.visible)return;this.history_viewer.loading=!1;let s="";!0===e.use_all_rounds||"true"===e.use_all_rounds||1===e.use_all_rounds?s="all":"string"==typeof e.round_id&&e.round_id.length&&(s=e.round_id);let i=this.history_viewer.requestedRound||"",r=s;(!r||""===r)&&"string"==typeof e.current_round_id&&e.current_round_id.length&&(r=e.current_round_id);let o=!1;if(i===r?o=!0:""===i&&r?o=!0:""!==i||r?"all"===i&&"all"===r&&(o=!0):o=!0,!o)return;if(this.history_viewer.roundId=i,this.history_viewer.resolvedRoundId=r||"",e.error&&"string"==typeof e.error&&e.error.length){this.history_viewer.error=e.error,this.history_viewer.messages=[],this.history_viewer.messageCount=0,this.history_viewer.roundLabel=this.resolve_history_round_label(i,r);return}let n=[];if(Array.isArray(e.messages)){let a=this;n=e.messages.map(function(e,t){if(!e||"object"!=typeof e)return null;let s="string"==typeof e.content?e.content:"",i=e.logged_at;if("string"==typeof i){let r=parseInt(i,10);i=isNaN(r)?0:r}isFinite(i)||(i=0);let o=e.worldtime;if("string"==typeof o){let n=parseInt(o,10);o=isNaN(n)?0:n}isFinite(o)||(o=0);let l="vc_unsorted";if(s){let c=a.get_category(s);"string"==typeof c&&c.length&&(l=c)}return{id:t+1,content:s,loggedAt:i,worldtime:o,category:l}}).filter(function(e){return null!==e})}let l=0;if("number"==typeof e.message_count)l=e.message_count;else if("string"==typeof e.message_count){let c=parseInt(e.message_count,10);l=isNaN(c)?n.length:c}else l=n.length;this.history_viewer.messages=n,this.history_viewer.messageCount=l,this.history_viewer.roundLabel=this.resolve_history_round_label(i,r),this.history_viewer.error=""},resolve_history_round_label:function(e,t){if("all"===e||"all"===t)return"All saved rounds";let s=e;if((!s||""===s)&&t&&(s=t),!s){let i=this.round_overview.currentRoundId;if(i){let r=this.round_overview.options.find(function(e){return e&&e.id===i});if(r)return r.startDisplay&&r.startDisplay.length?r.startDisplay:r.id}return"Current round"}let o=this.round_overview.options.find(function(e){return e&&e.id===s});return o?o.startDisplay&&o.startDisplay.length?o.startDisplay:o.id:s},select_round_option:function(e){if(!e)return;let t=e.use_all?"all":e.id;t||""===t||(t=""),this.complete_chatlog_save(t)&&this.close_round_selector()},select_current_round:function(){this.complete_chatlog_save("")&&this.close_round_selector()},select_all_rounds:function(){this.complete_chatlog_save("all")&&this.close_round_selector()},complete_chatlog_save:function(e){if(!this.pending_chatlog)return!1;let t=Array.isArray(this.pending_chatlog.categories)?this.pending_chatlog.categories.slice():[],s=this.pending_chatlog.filename;if(requestChatlogSave(s,t,"string"==typeof e?e:""))return!0;let i="<html><head><style>"+this.ext_styles+"</style></head><body>",r=t;return this.archived_messages.concat(this.messages).forEach(function(e){(0===r.length||r.indexOf(e.category)>=0)&&(i+=e.content,e.repeats>1&&(i+="(x"+e.repeats+")"),i+="<br>\n")}),i+="</body></html>",downloadBlob(new Blob([i],{type:"text/html;charset=utf8;"}),s),!0},cancel_round_selection:function(){this.close_round_selector()},close_round_selector:function(e){void 0===e&&(e=!0),this.round_selector.visible=!1,this.round_selector.loading=!1,this.round_selector.options=[],this.round_selector.error="",this.round_selector.totalMessages=0,this.round_selector.roundTotal=0,this.round_selector.currentOption=null,e&&(this.pending_chatlog=null)},do_latency_test:function(){send_latency_check()},reset_fontfamily:function(){this.fontfamily=this.fontfamily_default},blur_this:function(e){e.target.blur()}}})}function check_ping(){Date.now()-vchat_state.lastPingReceived>vchat_opts.msBeforeDropped&&(vueapp.reconnecting=!0)}function send_latency_check(){vchat_state.latency_sent||(vchat_state.latency_sent=Date.now(),vueapp.latency="?",push_Topic("ping"),setTimeout(function(){"?"==vchat_state.latency_ms&&(vchat_state.latency_ms=999)},1e3),setTimeout(function(){vchat_state.latency_sent=0,vueapp.latency=0},5e3))}function get_latency_check(){vchat_state.latency_sent&&(vueapp.latency=Date.now()-vchat_state.latency_sent)}function byondDecode(e){e=e.replace(/\+/g,"%20");try{e=decodeURIComponent(e)}catch(t){e=unescape(e+JSON.stringify(t))}return JSON.parse(e)}function putmessage(e){Array.isArray(e=byondDecode(e))?e.forEach(function(e){vueapp.add_message(e)}):"object"==typeof e&&vueapp.add_message(e)}function system_message(e){vueapp.internal_message(e)}function push_Topic(e){window.location="?_src_=chat&proc="+e}function push_Topic_showingnum(e){window.location="?_src_=chat&showingnum="+e}function focusMapWindow(){window.location="byond://winset?mapwindow.map.focus=true"}function send_debug(e){push_Topic("debug&param[message]="+encodeURIComponent(e))}function get_event(e){if(!vchat_state.ready){push_Topic("not_ready");return}let t={evttype:"internal_error",event:e};switch((t=byondDecode(e)).evttype){case"internal_error":system_message("Event parse error: "+e);break;case"byond_player":send_client_data(),vueapp.is_admin="true"===t.admin,vchat_state.byond_ip=t.address,vchat_state.byond_cid=t.cid,vchat_state.byond_ckey=t.ckey,set_storage("ip",vchat_state.byond_ip),set_storage("cid",vchat_state.byond_cid),set_storage("ckey",vchat_state.byond_ckey);break;case"keepalive":vchat_state.lastPingReceived=Date.now(),vueapp.reconnecting=!1;break;case"pong":get_latency_check();break;case"availability":push_Topic("done_loading");break;case"round_list":vueapp&&"function"==typeof vueapp.receive_round_list&&vueapp.receive_round_list(t);break;case"round_history":vueapp&&"function"==typeof vueapp.receive_round_history&&vueapp.receive_round_history(t);break;default:system_message("Didn't know what to do with event: "+e)}}function send_client_data(){push_Topic("ident&param[clientdata]="+JSON.stringify({ip:get_storage("ip"),cid:get_storage("cid"),ckey:get_storage("ckey")}))}function set_storage(e,t){storage_system&&storage_system.setItem(vchat_opts.cookiePrefix+e,t)}function get_storage(e,t){if(!storage_system)return t;let s=storage_system.getItem(vchat_opts.cookiePrefix+e);return"null"===s||null===s?s=t:"true"===s?s=!0:"false"===s?s=!1:isNaN(s)||(s=+s),s}function storageAvailable(e){var t;try{t=window[e];var s="__storage_test__";return t.setItem(s,s),t.getItem(s),t.removeItem(s),!0}catch(i){return i instanceof DOMException&&(22===i.code||1014===i.code||"QuotaExceededError"===i.name||"NS_ERROR_DOM_QUOTA_REACHED"===i.name)&&t&&0!==t.length}}function downloadBlob(e,t){if(navigator.userAgent.indexOf("Trident")>=0&&navigator.msSaveOrOpenBlob)navigator.msSaveOrOpenBlob(e,t);else{let s=URL.createObjectURL(e),i=document.createElement("a");i.href=s,i.download=t,document.body.appendChild(i),i.click(),setTimeout(function(){document.body.removeChild(i),URL.revokeObjectURL(s)},0)}}function requestChatlogSave(e,t,s){try{let i={filename:e,categories:Array.isArray(t)?t:[],round_id:"string"==typeof s?s:""};return push_Topic("save_chatlog&param[data]="+encodeURIComponent(JSON.stringify(i))),!0}catch(r){return console.error(r),!1}}
